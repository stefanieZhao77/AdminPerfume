---
import Head from "@components/_head.astro"
import Footer from "@components/dashboard/_footer.astro"
import Topbar from "@components/dashboard/_topbar.astro"
import Sidenav from "@components/dashboard/_sidenav.astro"
import Scripts from "@components/_scripts.astro"
import QueryTable from "@components/QueryTable.astro"

const title = "客户管理"
const path = "../../../dist"
const mainPage = "customers"
const page = "customers-list"
---

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <Head title={title} path={path} />
    <style is:inline>
      .table-sticky thead th { position: sticky; top: 0; z-index: 2; background: var(--bs-body-bg); }
      .table thead th { white-space: nowrap; }
      .qt-col-btn { white-space: nowrap; }
    </style>
  </head>
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
      <Topbar path={path} />
      <Sidenav path={path} mainPage={mainPage} page={page} />
      <main class="app-main">
        <div class="app-content-header">
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-6"><h3 class="mb-0">客户管理</h3></div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item"><a href="#">首页</a></li>
                  <li class="breadcrumb-item active" aria-current="page">客户管理</li>
                </ol>
              </div>
            </div>
          </div>
        </div>
        <div class="app-content">
          <div class="container-fluid">
            <div class="card mb-4">
              <div class="card-header"><h3 class="card-title">查询</h3></div>
              <div class="card-body">
                <form id="customers-form" class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">客户/联系人</label>
                    <input id="kw" type="text" class="form-control" placeholder="搜索..." />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">类型</label>
                    <select id="type" class="form-select">
                      <option value="">全部</option>
                      <option>个人</option>
                      <option>企业</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">创建日期</label>
                    <input id="date" type="date" class="form-control" />
                  </div>
                  <div class="col-md-2 align-self-end">
                    <button id="searchBtn" type="button" class="btn btn-primary me-2">查询</button>
                    <button id="resetBtn" type="button" class="btn btn-outline-secondary">重置</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="card">
              <div class="card-header d-flex align-items-center justify-content-between">
                <h3 class="card-title">客户列表</h3>
                <div class="qt-col-menu">
                  <button class="btn btn-outline-secondary btn-sm me-2" id="exportBtn">导出可见列</button>
                  <button class="btn btn-outline-secondary btn-sm qt-col-btn" id="colMenuBtn">列显示/隐藏</button>
                  <div class="qt-dropdown" id="colMenu"></div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 520px;">
                  <table class="table table-hover mb-0 table-sticky" id="customers-table">
                    <thead class="table-light border-bottom">
                      <tr>
                        <th data-qt-key="id" style="width: 140px">客户ID</th>
                        <th data-qt-key="name">名称</th>
                        <th data-qt-key="contact">联系人</th>
                        <th data-qt-key="phone">电话</th>
                        <th data-qt-key="type">类型</th>
                        <th data-qt-key="orders">订单数</th>
                        <th data-qt-key="createdAt" style="width: 160px">创建时间</th>
                      </tr>
                    </thead>
                    <tbody id="customers-tbody"></tbody>
                  </table>
                </div>
              </div>
              <div class="card-footer d-flex align-items-center justify-content-between">
                <div class="text-body-secondary small" id="customers-stats">共 0 条</div>
                <ul class="pagination pagination-sm m-0" id="customers-pagination"></ul>
              </div>
            </div>
          </div>
        </div>
      </main>
      <Footer />
    </div>
    <Scripts path={path} />
    <QueryTable />

    <script is:inline>
      function randomPhone(){ return '1' + Math.floor(3+Math.random()*6) + String(Math.floor(10_000_000 + Math.random()*89_999_999)) }
      function randomDate(){ const t = Date.now() - Math.random()*365*24*3600*1000; return new Date(t).toISOString().slice(0,10) }
      const types = ['个人','企业']
      const mockCustomers = Array.from({length: 98}, (_,i)=>({
        id: `C-${String(i+1).padStart(4,'0')}`,
        name: `${types[i%2]}客户${i+1}`,
        contact: `联系人${(i%50)+1}`,
        phone: randomPhone(),
        type: types[i%2],
        orders: Math.floor(Math.random()*40),
        createdAt: randomDate()
      }))

      const state = { page: 1, pageSize: 10, kw: '', type: '', date: '' }
      function filterData(){
        return mockCustomers.filter(c=>{
          const hitKw = state.kw==='' || [c.id,c.name,c.contact,c.phone].some(v=>v.toLowerCase().includes(state.kw.toLowerCase()))
          const hitType = state.type==='' || c.type===state.type
          const hitDate = state.date==='' || c.createdAt===state.date
          return hitKw && hitType && hitDate
        })
      }

      const qt = window.QueryTable.create({
        storageKey: 'customers',
        pageSize: state.pageSize,
        tableSelector: '#customers-table',
        tbodySelector: '#customers-tbody',
        statsSelector: '#customers-stats',
        paginationSelector: '#customers-pagination',
        colMenuButtonSelector: '#colMenuBtn',
        colMenuDropdownSelector: '#colMenu',
        exportButtonSelector: '#exportBtn',
        columns: [
          { key: 'id', label: '客户ID', visible: true, width: '140px' },
          { key: 'name', label: '名称', visible: true },
          { key: 'contact', label: '联系人', visible: true },
          { key: 'phone', label: '电话', visible: true },
          { key: 'type', label: '类型', visible: true },
          { key: 'orders', label: '订单数', visible: true },
          { key: 'createdAt', label: '创建时间', visible: true, width: '160px' },
        ],
        getFilteredData: ()=> filterData(),
        renderRow: (c)=> `
          <tr class="align-middle">
            <td><span class="fw-medium">${c.id}</span></td>
            <td>${c.name}</td>
            <td>${c.contact}</td>
            <td>${c.phone}</td>
            <td>${c.type}</td>
            <td>${c.orders}</td>
            <td>${c.createdAt}</td>
          </tr>`,
        getCellValue: (c, key)=> c[key] ?? ''
      })

      function bindEvents(){
        document.getElementById('customers-pagination').addEventListener('click', e=>{
          const a = e.target.closest('a.page-link'); if(!a) return; e.preventDefault()
          const p = Number(a.dataset.page); if(Number.isNaN(p)) return
          qt.state.page = Math.max(1, p)
          qt.render()
        })
        document.getElementById('searchBtn').addEventListener('click', ()=>{
          state.kw = document.getElementById('kw').value.trim()
          state.type = document.getElementById('type').value
          state.date = document.getElementById('date').value
          qt.state.page = 1; qt.render()
        })
        document.getElementById('resetBtn').addEventListener('click', ()=>{
          document.getElementById('customers-form').reset()
          state.kw=''; state.type=''; state.date=''; qt.state.page=1; qt.render()
        })
        document.getElementById('kw').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('searchBtn').click() }})
      }

      bindEvents(); qt.render();
    </script>
  </body>
</html>
