---
import Head from "@components/_head.astro"
import Footer from "@components/dashboard/_footer.astro"
import Topbar from "@components/dashboard/_topbar.astro"
import Sidenav from "@components/dashboard/_sidenav.astro"
import Scripts from "@components/_scripts.astro"
import QueryTable from "@components/QueryTable.astro"

const title = "GC-MS"
const path = "../../../dist"
const mainPage = "gcms"
const page = "gcms-list"
---

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <Head title={title} path={path} />
    <style is:inline>
      .table-sticky thead th { position: sticky; top: 0; z-index: 2; background: var(--bs-body-bg); }
      .table thead th { white-space: nowrap; }
      .qt-col-btn { white-space: nowrap; }
    </style>
  </head>
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
      <Topbar path={path} />
      <Sidenav path={path} mainPage={mainPage} page={page} />
      <main class="app-main">
        <div class="app-content-header">
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-6"><h3 class="mb-0">GC-MS</h3></div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item"><a href="#">首页</a></li>
                  <li class="breadcrumb-item active" aria-current="page">GC-MS</li>
                </ol>
              </div>
            </div>
          </div>
        </div>
        <div class="app-content">
          <div class="container-fluid">
            <div class="card mb-4">
              <div class="card-header"><h3 class="card-title">查询</h3></div>
              <div class="card-body">
                <form id="gcms-form" class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">样品关键词</label>
                    <input id="kw" type="text" class="form-control" placeholder="样品名/编号" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">状态</label>
                    <select id="status" class="form-select">
                      <option value="">全部</option>
                      <option>待解析</option>
                      <option>解析中</option>
                      <option>已完成</option>
                      <option>失败</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">测试日期</label>
                    <input id="date" type="date" class="form-control" />
                  </div>
                  <div class="col-md-2 align-self-end">
                    <button id="searchBtn" type="button" class="btn btn-primary me-2">查询</button>
                    <button id="resetBtn" type="button" class="btn btn-outline-secondary">重置</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="card">
              <div class="card-header d-flex align-items-center justify-content-between">
                <h3 class="card-title">样品列表</h3>
                <div class="qt-col-menu">
                  <button class="btn btn-outline-secondary btn-sm me-2" id="exportBtn">导出可见列</button>
                  <button class="btn btn-outline-secondary btn-sm qt-col-btn" id="colMenuBtn">列显示/隐藏</button>
                  <div class="qt-dropdown" id="colMenu"></div>
                </div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 520px;">
                  <table class="table table-hover mb-0 table-sticky" id="gcms-table">
                    <thead class="table-light border-bottom">
                      <tr>
                        <th data-qt-key="id" style="width: 140px">样品ID</th>
                        <th data-qt-key="name">名称</th>
                        <th data-qt-key="lot">批次</th>
                        <th data-qt-key="date">测试日期</th>
                        <th data-qt-key="status">状态</th>
                        <th data-qt-key="actions" style="width: 120px">操作</th>
                      </tr>
                    </thead>
                    <tbody id="gcms-tbody"></tbody>
                  </table>
                </div>
              </div>
              <div class="card-footer d-flex align-items-center justify-content-between">
                <div class="text-body-secondary small" id="gcms-stats">共 0 条</div>
                <ul class="pagination pagination-sm m-0" id="gcms-pagination"></ul>
              </div>
            </div>
          </div>
        </div>
      </main>
      <Footer />
    </div>
    <Scripts path={path} />
    <QueryTable />

    <script is:inline>
      const statuses = ['待解析','解析中','已完成','失败']
      function randomDate(){ const t = Date.now() - Math.random()*120*24*3600*1000; return new Date(t).toISOString().slice(0,10) }
      const mockSamples = Array.from({length: 86}, (_,i)=>({
        id: `SP-${String(i+1).padStart(4,'0')}`,
        name: `样品${i+1}`,
        lot: `${2024 - Math.floor(i/30)}${(i%12+1).toString().padStart(2,'0')}A`,
        date: randomDate(),
        status: statuses[(i*13)%statuses.length]
      }))

      const state = { page: 1, pageSize: 10, kw: '', status: '', date: '' }
      function filterData(){
        return mockSamples.filter(s=>{
          const hitKw = state.kw==='' || [s.id,s.name,s.lot].some(v=>v.toLowerCase().includes(state.kw.toLowerCase()))
          const hitSt = state.status==='' || s.status===state.status
          const hitDate = state.date==='' || s.date===state.date
          return hitKw && hitSt && hitDate
        })
      }

      function badge(st){ const map = { '待解析':'secondary','解析中':'info','已完成':'success','失败':'danger' }; return `<span class=\"badge text-bg-${map[st]||'secondary'}\">${st}</span>` }

      const qt = window.QueryTable.create({
        storageKey: 'gcms',
        pageSize: state.pageSize,
        tableSelector: '#gcms-table',
        tbodySelector: '#gcms-tbody',
        statsSelector: '#gcms-stats',
        paginationSelector: '#gcms-pagination',
        colMenuButtonSelector: '#colMenuBtn',
        colMenuDropdownSelector: '#colMenu',
        exportButtonSelector: '#exportBtn',
        columns: [
          { key: 'id', label: '样品ID', visible: true, width: '140px' },
          { key: 'name', label: '名称', visible: true },
          { key: 'lot', label: '批次', visible: true },
          { key: 'date', label: '测试日期', visible: true },
          { key: 'status', label: '状态', visible: true },
          { key: 'actions', label: '操作', visible: true, width: '120px' },
        ],
        getFilteredData: ()=> filterData(),
        renderRow: (s)=> `
          <tr class="align-middle">
            <td><span class="fw-medium">${s.id}</span></td>
            <td>${s.name}</td>
            <td>${s.lot}</td>
            <td>${s.date}</td>
            <td>${badge(s.status)}</td>
            <td><button class="btn btn-link btn-sm" data-action="view" data-id="${s.id}">查看</button></td>
          </tr>`,
        getCellValue: (s, key)=> key==='status'? s.status : (key==='actions'?'': (s[key]??''))
      })

      function bindEvents(){
        document.getElementById('gcms-pagination').addEventListener('click', e=>{
          const a = e.target.closest('a.page-link'); if(!a) return; e.preventDefault()
          const p = Number(a.dataset.page); if(Number.isNaN(p)) return
          qt.state.page = Math.max(1, p)
          qt.render()
        })
        document.getElementById('searchBtn').addEventListener('click', ()=>{
          state.kw = document.getElementById('kw').value.trim()
          state.status = document.getElementById('status').value
          state.date = document.getElementById('date').value
          qt.state.page = 1; qt.render()
        })
        document.getElementById('resetBtn').addEventListener('click', ()=>{
          document.getElementById('gcms-form').reset()
          state.kw=''; state.status=''; state.date=''; qt.state.page=1; qt.render()
        })
        document.getElementById('gcms-table').addEventListener('click', e=>{
          const btn = e.target.closest('button[data-action="view"]'); if(!btn) return
          const id = btn.dataset.id
          alert(`查看 ${id} 的详情（占位）`)
        })
        document.getElementById('kw').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('searchBtn').click() }})
      }

      bindEvents(); qt.render();
    </script>
  </body>
</html>
