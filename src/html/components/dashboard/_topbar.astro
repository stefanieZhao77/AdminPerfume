---
// Smart path resolution: calculate relative path based on directory depth
const pathname = Astro.url.pathname;
const pathSegments = pathname.split('/').filter(segment => segment !== '');
const depth = pathSegments.length > 0 ? pathSegments.length - 1 : 0;
const deploymentPath = depth === 0 ? './' : '../'.repeat(depth);
---

<!--begin::Header-->
<nav class="app-header navbar navbar-expand bg-body">
  <!--begin::Container-->
  <div class="container-fluid">
    <!--begin::Start Navbar Links-->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
          <i class="bi bi-list"></i>
        </a>
      </li>
      <li class="nav-item d-none d-md-block">
        <a href="#" class="nav-link" data-i18n="home">首页</a>
      </li>
      <li class="nav-item d-none d-md-block">
        <a href="#" class="nav-link" data-i18n="contact">联系</a>
      </li>
    </ul>
    <!--end::Start Navbar Links-->

    <!--begin::End Navbar Links-->
    <ul class="navbar-nav ms-auto">
      <!--begin::Navbar Search-->
      <li class="nav-item">
        <a class="nav-link" data-widget="navbar-search" href="#" role="button">
          <i class="bi bi-search"></i>
        </a>
      </li>
      <!--end::Navbar Search-->

      <!--begin::Messages Dropdown Menu-->
      <li class="nav-item dropdown">
        <a class="nav-link" data-bs-toggle="dropdown" href="#">
          <i class="bi bi-chat-text"></i>
          <span class="navbar-badge badge text-bg-danger">3</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
          <a href="#" class="dropdown-item">
            <!--begin::Message-->
            <div class="d-flex">
              <div class="flex-shrink-0">
                <img
                  src={deploymentPath + "assets/img/user1-128x128.jpg"}
                  alt="User Avatar"
                  class="img-size-50 rounded-circle me-3"
                />
              </div>
              <div class="flex-grow-1">
                <h3 class="dropdown-item-title">
                  Brad Diesel
                  <span class="float-end fs-7 text-danger"
                  ><i class="bi bi-star-fill"></i></span
                  >
                </h3>
                <p class="fs-7">Call me whenever you can...</p>
                <p class="fs-7 text-secondary">
                  <i class="bi bi-clock-fill me-1"></i> 4 Hours Ago
                </p>
              </div>
            </div>
            <!--end::Message-->
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <!--begin::Message-->
            <div class="d-flex">
              <div class="flex-shrink-0">
                <img
                  src={deploymentPath + "assets/img/user8-128x128.jpg"}
                  alt="User Avatar"
                  class="img-size-50 rounded-circle me-3"
                />
              </div>
              <div class="flex-grow-1">
                <h3 class="dropdown-item-title">
                  John Pierce
                  <span class="float-end fs-7 text-secondary">
                    <i class="bi bi-star-fill"></i>
                  </span>
                </h3>
                <p class="fs-7">I got your message bro</p>
                <p class="fs-7 text-secondary">
                  <i class="bi bi-clock-fill me-1"></i> 4 Hours Ago
                </p>
              </div>
            </div>
            <!--end::Message-->
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <!--begin::Message-->
            <div class="d-flex">
              <div class="flex-shrink-0">
                <img
                  src={deploymentPath + "assets/img/user3-128x128.jpg"}
                  alt="User Avatar"
                  class="img-size-50 rounded-circle me-3"
                />
              </div>
              <div class="flex-grow-1">
                <h3 class="dropdown-item-title">
                  Nora Silvester
                  <span class="float-end fs-7 text-warning">
                    <i class="bi bi-star-fill"></i>
                  </span>
                </h3>
                <p class="fs-7">The subject goes here</p>
                <p class="fs-7 text-secondary">
                  <i class="bi bi-clock-fill me-1"></i> 4 Hours Ago
                </p>
              </div>
            </div>
            <!--end::Message-->
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item dropdown-footer" data-i18n="seeAllMessages">查看所有消息</a>
        </div>
      </li>
      <!--end::Messages Dropdown Menu-->

      <!--begin::Notifications Dropdown Menu-->
      <li class="nav-item dropdown">
        <a class="nav-link" data-bs-toggle="dropdown" href="#">
          <i class="bi bi-bell-fill" style="font-size: 1rem; display: inline-block; color: #ffc107;"></i>
          <span class="navbar-badge badge text-bg-warning">15</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
          <span class="dropdown-item dropdown-header" data-i18n="notifications">15 通知</span>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="bi bi-envelope me-2"></i> <span data-i18n="newMessagesCount">4 条新消息</span>
            <span class="float-end text-secondary fs-7" data-i18n="mins">3 分钟</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="bi bi-people-fill me-2"></i> <span data-i18n="friendRequestsCount">8 个好友请求</span>
            <span class="float-end text-secondary fs-7" data-i18n="hoursCount">12 小时</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="bi bi-file-earmark-fill me-2"></i> <span data-i18n="newReportsCount">3 个新报告</span>
            <span class="float-end text-secondary fs-7" data-i18n="daysCount">2 天</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item dropdown-footer" data-i18n="seeAllNotifications">
            查看所有通知
          </a>
        </div>
      </li>
      <!--end::Notifications Dropdown Menu-->

      <!--begin::Language Dropdown Menu-->
      <li class="nav-item dropdown">
        <a class="nav-link" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
          <i class="bi bi-translate"></i>
          <span id="current-language-flag" class="ms-1">🇨🇳</span>
        </a>
        <div class="dropdown-menu dropdown-menu-end">
          <h6 class="dropdown-header">选择语言 / Select Language</h6>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item language-option" data-lang="zh">
            <span class="me-2">🇨🇳</span> 中文
          </a>
          <a href="#" class="dropdown-item language-option" data-lang="en">
            <span class="me-2">🇺🇸</span> English
          </a>
        </div>
      </li>
      <!--end::Language Dropdown Menu-->

      <!--begin::Fullscreen Toggle-->
      <li class="nav-item">
        <a class="nav-link" href="#" data-lte-toggle="fullscreen">
          <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
          <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none;"></i>
        </a>
      </li>
      <!--end::Fullscreen Toggle-->

      <!--begin::User Menu Dropdown-->
      <li class="nav-item dropdown user-menu">
        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
          <div id="navUserAvatar" class="user-image rounded-circle shadow d-flex align-items-center justify-content-center text-white fw-bold" 
               style="width: 30px; height: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem;">
            A
          </div>
          <span class="d-none d-md-inline ms-1" id="userDisplayName">
            未登录
          </span>
        </a>
        <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
          <!--begin::User Image-->
          <li class="user-header text-bg-primary">
            <div id="topbarUserAvatar" class="rounded-circle shadow d-flex align-items-center justify-content-center text-white fw-bold mx-auto mb-2" 
                 style="width: 90px; height: 90px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 2rem;">
              A
            </div>
            <p>
              <span id="userName">未登录</span> - 
              <span id="userRole"></span>
              <small>登录时间: <span id="loginTime"></span></small>
            </p>
          </li>
          <!--end::User Image-->
          <!--begin::Menu Body-->
          <li class="user-body">
            <!--begin::Row-->
            <div class="row">
              <div class="col-4 text-center">
                <a href="#" data-i18n="orders">订单</a>
              </div>
              <div class="col-4 text-center">
                <a href="#" data-i18n="formulas">配方</a>
              </div>
              <div class="col-4 text-center">
                <a href="#" data-i18n="tasks">任务</a>
              </div>
            </div>
            <!--end::Row-->
          </li>
          <!--end::Menu Body-->
          <!--begin::Menu Footer-->
          <li class="user-footer">
            <a href="#" class="btn btn-default btn-flat" data-i18n="profile">个人资料</a>
            <a href="#" class="btn btn-default btn-flat float-end" onclick="logout()" data-i18n="signOut">退出登录</a>
          </li>
          <!--end::Menu Footer-->
        </ul>
      </li>
      <!--end::User Menu Dropdown-->
    </ul>
    <!--end::End Navbar Links-->
  </div>
  <!--end::Container-->
</nav>
<!--end::Header-->

<style is:inline>
  /* 修复用户头像样式 */
  .user-menu .nav-link {
    display: flex !important;
    align-items: center;
  }
  
  .user-menu .user-image {
    margin-right: 0.5rem;
    flex-shrink: 0;
  }
  
  .user-menu #userDisplayName {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
  }
  
  /* 确保通知图标可见 */
  .bi-bell-fill {
    display: inline-block !important;
    font-size: 1rem;
  }
  
  /* 确保所有Bootstrap Icons可见 */
  .bi {
    display: inline-block !important;
  }
  
  /* 通知图标特殊样式 */
  .nav-item.dropdown .bi-bell-fill {
    font-size: 1.1rem !important;
    color: #ffc107 !important;
    margin-right: 0.25rem;
  }
  
  /* 确保通知徽章可见 */
  .navbar-badge {
    position: absolute;
    top: 0;
    right: 0;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
</style>

<script is:inline>
  // 获取当前用户信息
  function getCurrentUser() {
    if (typeof globalThis.sessionStorage !== 'undefined') {
      const userStr = globalThis.sessionStorage.getItem('currentUser')
      return userStr ? JSON.parse(userStr) : null
    }
    return null
  }
  
  function logout() {
    if (typeof globalThis.sessionStorage !== 'undefined') {
      globalThis.sessionStorage.removeItem('currentUser')
    }
    globalThis.location.href = '/login.html'
  }
  
  // 更新用户信息显示
  function updateUserInfo() {
    const user = getCurrentUser()
    if (user) {
      const userNameElements = document.querySelectorAll('#userName, #userDisplayName')
      const userRoleElement = document.getElementById('userRole')
      const loginTimeElement = document.getElementById('loginTime')
      
      userNameElements.forEach(el => {
        if (el) el.textContent = user.name || user.username
      })
      
      // 更新顶部导航栏用户头像（使用用户名首字母）
      const topbarUserAvatar = document.getElementById('topbarUserAvatar')
      if (topbarUserAvatar) {
        const firstLetter = user.username.charAt(0).toUpperCase()
        topbarUserAvatar.textContent = firstLetter
      }
      
      // 更新右上角导航栏用户头像
      const navUserAvatar = document.getElementById('navUserAvatar')
      if (navUserAvatar) {
        const firstLetter = user.username.charAt(0).toUpperCase()
        navUserAvatar.textContent = firstLetter
      }
      
      if (userRoleElement) {
        userRoleElement.textContent = user.role === 'admin' ? '技术总监' : 
                                     user.role === 'perfumer' ? '调香师' : '评香师'
      }
      
      if (loginTimeElement) {
        loginTimeElement.textContent = new Date(user.loginTime).toLocaleString('zh-CN')
      }
    } else {
      // 如果没有用户信息，跳转到登录页面
      globalThis.location.href = '/login.html'
    }
  }
  
  // 页面加载时更新用户信息
  document.addEventListener('DOMContentLoaded', function() {
    updateUserInfo()
  })
  
  // 立即执行一次更新
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', updateUserInfo)
  } else {
    updateUserInfo()
  }
</script>

